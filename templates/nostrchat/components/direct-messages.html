<div class="row no-wrap">
  <!-- Sidebar - only visible for admins and when should show peer list -->
  <div v-if="isSuper && showPeerList" 
       :class="isMobile ? 'col-12' : 'col-3'" 
       style="min-width: 250px; border-right: 1px solid #ddd;">
    <!-- Search and Add buttons -->
    <div class="row q-pa-sm">
      <div class="col">
        <q-input
          v-model="search"
          dense
          outlined
          placeholder="Search peers"
          class="full-width"
        >
          <template v-slot:append>
            <q-icon name="search" />
          </template>
        </q-input>
      </div>
      <div class="col-auto q-pl-sm">
        <q-btn
          flat
          round
          dense
          icon="person_add"
          @click="showAddPublicKey = true"
        >
          <q-tooltip>Add a public key to chat with</q-tooltip>
        </q-btn>
      </div>
    </div>

    <!-- Peer List -->
    <q-list padding separator>
      <q-item
        v-for="peer in filteredPeers"
        :key="peer.public_key"
        clickable
        v-ripple
        :active="activePublicKey === peer.public_key"
        active-class="bg-primary text-white"
        @click="activePublicKey = peer.public_key; selectActivePeer()"
      >
        <q-item-section avatar>
          <q-avatar>
            <q-icon name="person" />
          </q-avatar>
        </q-item-section>

        <q-item-section>
          <q-item-label v-text="peer.profile.name || 'Unknown'"></q-item-label>
          <q-item-label caption lines="1" v-text="peer.public_key.slice(0, 8) + '...' + peer.public_key.slice(-8)">
          </q-item-label>
        </q-item-section>

        <q-item-section side v-if="peer.unread_messages">
          <q-badge color="primary" floating v-text="peer.unread_messages"></q-badge>
        </q-item-section>
      </q-item>
    </q-list>
  </div>

  <!-- Main chat area -->
  <div v-if="showChatArea" :class="isMobile ? 'col-12' : 'col'">
    <q-card>
      <q-card-section>
        <div class="row items-center">
          <!-- Back button on mobile -->
          <div v-if="isMobile" class="col-auto q-pr-sm">
            <q-btn
              flat
              round
              dense
              icon="arrow_back"
              @click="clearActivePeer"
            />
          </div>
          <div class="col">
            <h6 class="text-subtitle1 q-my-none">Messages</h6>
          </div>
        </div>
      </q-card-section>
      <q-card-section class="q-pa-none">
        <q-separator></q-separator>
      </q-card-section>
      <q-card-section>
        <div class="chat-container" ref="chatCard">
          <div class="chat-box">
            <div class="chat-messages" style="height: 45vh">
              <q-chat-message
                v-for="(dm, index) in messagesAsJson"
                :key="index"
                :name="dm.incoming ? 'peer': 'me'"
                :sent="!dm.incoming"
                :stamp="dm.dateFrom"
                :bg-color="dm.incoming ? 'white' : 'light-green-2'"
                :class="'chat-mesage-index-'+index"
              >
                <!-- Leaving future reference to implement enums -->

                <!-- <div v-if="dm.isJson"> -->
                <!--   <div v-if="dm.message.type === 0"> -->
                <!--     <strong>New order:</strong> -->
                <!--   </div> -->
                <!--   <div v-else-if="dm.message.type === 1"> -->
                <!--     <strong>Reply sent for order: </strong> -->
                <!--   </div> -->
                <!--   <div v-else-if="dm.message.type === 2"> -->
                <!--     <q-badge v-if="dm.message.paid" color="green">Paid </q-badge> -->
                <!--     <q-badge v-if="dm.message.shipped" color="green" -->
                <!--       >Shipped -->
                <!--     </q-badge> -->
                <!--   </div> -->
                <!--   <div> -->
                <!--     <span v-text="dm.message.message"></span> -->
                <!--     <q-badge color="orange"> -->
                <!--       <span -->
                <!--         v-text="dm.message.id" -->
                <!--         @click="showOrderDetails(dm.message.id, dm.event_id)" -->
                <!--         class="cursor-pointer" -->
                <!--       ></span> -->
                <!--     </q-badge> -->
                <!--   </div> -->
                <!--   <q-badge -->
                <!--     @click="showMessageRawData(index)" -->
                <!--     class="cursor-pointer" -->
                <!--     >...</q-badge -->
                <!--   > -->
                <!-- </div> -->
                <!-- <div v-else><span v-text="dm.message"></span></div> -->
                <div><span v-text="dm.message"></span></div>
              </q-chat-message>
            </div>
          </div>
          <q-card-section>
            <q-form @submit="sendDirectMessage" class="full-width chat-input">
              <q-input
                ref="newMessage"
                v-model="newMessage"
                placeholder="Message"
                class="full-width"
                dense
                outlined
              >
              <q-btn
                round
                dense
                flat
                type="submit"
                icon="send"
                color="primary"
                :disable="!newMessage.trim() || !activePublicKey"
              />
              </q-input>
            </q-form>
          </q-card-section>
        </div>
      </q-card-section>
    </q-card>
  </div>

  <!-- Existing dialogs -->
  <q-dialog v-model="showAddPublicKey" position="top">
    <q-card class="q-pa-lg q-pt-xl" style="width: 500px">
      <q-form @submit="addPublicKey()" class="q-gutter-md">
        <q-input
          filled
          dense
          v-model.trim="newPublicKey"
          label="Public Key (hex or nsec)"
        ></q-input>
        <div class="row q-mt-lg">
          <q-btn
            unelevated
            color="primary"
            :disable="!newPublicKey"
            type="submit"
            >Add</q-btn
          >
          <q-btn v-close-popup flat color="grey" class="q-ml-auto"
            >Cancel</q-btn
          >
        </div>
      </q-form>
    </q-card>
  </q-dialog>
  <q-dialog v-model="showRawMessage" position="top">
    <q-card class="q-pa-lg q-pt-xl" style="width: 500px">
      <q-form>
        <q-input
          filled
          dense
          type="textarea"
          rows="20"
          v-model.trim="rawMessage"
          label="Raw Data"
        ></q-input>
        <div class="row q-mt-lg">
          <q-btn v-close-popup flat color="grey" class="q-ml-auto"
            >Close</q-btn
          >
        </div>
      </q-form>
    </q-card>
  </q-dialog>
</div>

<style>
.chat-container {
  height: calc(100vh - 150px);
  display: flex;
  flex-direction: column;
}

.chat-box {
  flex: 1;
  overflow-y: auto;
}

.chat-messages {
  padding: 1rem;
}

.chat-input {
  padding: 1rem;
  border-top: 1px solid #ddd;
}
</style>
